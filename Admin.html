<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Smart Room Booking</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CONFIGURATION ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbzjmL3ZNd3a6Syiv720O3zfNAZYasTuQneB6LiQc5CIbc21STCpWJTJykxlzZ6E_Q2Z/exec';

        // --- 2. ICONS ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const CheckIcon = (props) => <Icon {...props} path={<polyline points="20 6 9 17 4 12"></polyline>} />;
        const XIcon = (props) => <Icon {...props} path={<><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>} />;
        const UserIcon = (props) => <Icon {...props} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></>} />;
        const LogOutIcon = (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></>} />;
        const BellIcon = (props) => <Icon {...props} path={<><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></>} />;
        const ClockIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>} />;

        const ROOM_NAMES = {
            '1-201': 'ห้อง 1-201 (ห้อง Mac)',
            '3-101': 'ห้องประชุมพุคยาภรณ์ 1',
            '2-304': 'ห้องบรรยาย 2-304'
        };

        // --- 3. COMPONENTS ---

        const Login = ({ onLogin }) => (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md animate-fadeIn">
                    <div className="text-center mb-8">
                        <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <UserIcon className="w-10 h-10 text-indigo-600" />
                        </div>
                        <h1 className="text-2xl font-bold text-gray-800">เข้าสู่ระบบเจ้าหน้าที่</h1>
                        <p className="text-gray-500">Smart Room Booking Admin Panel</p>
                    </div>
                    <form onSubmit={(e) => { e.preventDefault(); onLogin(); }} className="space-y-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">รหัสเจ้าหน้าที่</label>
                            <input type="text" value="admin" readOnly className="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-500 cursor-not-allowed" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน</label>
                            <input type="password" value="123456" readOnly className="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-500 cursor-not-allowed" />
                            <p className="text-xs text-right text-gray-400 mt-1">*Demo Mode</p>
                        </div>
                        <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300 shadow-lg transform hover:-translate-y-0.5">
                            เข้าสู่ระบบ
                        </button>
                    </form>
                </div>
            </div>
        );

        const Dashboard = ({ onLogout }) => {
            const [bookings, setBookings] = React.useState([]);
            const [filter, setFilter] = React.useState('pending'); // 'all', 'pending', 'approved', 'rejected'
            const [isLoading, setIsLoading] = React.useState(false);

            // Fetch Data from Google Sheet
            React.useEffect(() => {
                const fetchData = async () => {
                    try {
                        // ดึงข้อมูล (GET request)
                        const response = await fetch(API_URL);
                        const data = await response.json();
                        
                        // ตรวจสอบว่า data เป็น array หรือไม่ (ป้องกัน error)
                        if (Array.isArray(data)) {
                            setBookings(data);
                        } else {
                            console.error("Data format incorrect:", data);
                        }
                    } catch (error) {
                        console.error("Error fetching data:", error);
                    }
                };

                fetchData(); // เรียกครั้งแรกทันที
                const interval = setInterval(fetchData, 10000); // อัปเดตทุก 10 วินาที
                return () => clearInterval(interval);
            }, []);

            // Function: Update Status to Google Sheet
            const handleStatusChange = async (id, newStatus) => {
                // 1. Optimistic Update (อัปเดตหน้าจอทันทีเพื่อให้รู้สึกเร็ว)
                const originalBookings = [...bookings];
                const updated = bookings.map(b => b.id === id ? { ...b, status: newStatus } : b);
                setBookings(updated);

                try {
                    // 2. ส่งข้อมูลไป Google Sheet
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors', // สำคัญมากสำหรับ Google Script
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'updateStatus', // บอก Backend ว่านี่คือการอัปเดต
                            id: id,
                            status: newStatus
                        })
                    });
                    
                    console.log(`Sent update for ID: ${id} -> ${newStatus}`);

                } catch (error) {
                    console.error("Error updating status:", error);
                    alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล กรุณาลองใหม่อีกครั้ง");
                    setBookings(originalBookings); // คืนค่าเดิมถ้าพัง
                }
            };

            const getStatusBadge = (status) => {
                switch(status) {
                    case 'pending': return <span className="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700 border border-yellow-200">รอตรวจสอบ</span>;
                    case 'approved': return <span className="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700 border border-green-200">อนุมัติแล้ว</span>;
                    case 'rejected': return <span className="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700 border border-red-200">ไม่อนุมัติ</span>;
                    default: return null;
                }
            };

            const formatDate = (dateString) => {
                if (!dateString) return "-";
                const date = new Date(dateString);
                return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
            };

            const filteredBookings = filter === 'all' ? bookings : bookings.filter(b => b.status === filter);
            const pendingCount = bookings.filter(b => b.status === 'pending').length;

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-indigo-600 p-2 rounded-lg">
                                    <BellIcon className="w-5 h-5 text-white" />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-800">ระบบจัดการห้องประชุม</h1>
                                    <p className="text-xs text-gray-500">สำหรับเจ้าหน้าที่ (Admin)</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="hidden md:block text-right">
                                    <p className="text-sm font-semibold text-gray-700">เจ้าหน้าที่ งานวิชาการ</p>
                                    <p className="text-xs text-gray-400">Admin ID: 8859</p>
                                </div>
                                <button onClick={onLogout} className="p-2 text-gray-400 hover:text-red-500 transition-colors">
                                    <LogOutIcon className="w-6 h-6" />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-6xl mx-auto px-4 py-8 w-full flex-grow">
                        
                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div onClick={() => setFilter('pending')} className={`bg-white p-6 rounded-xl shadow-sm border cursor-pointer transition-all ${filter === 'pending' ? 'ring-2 ring-indigo-500 border-indigo-500' : 'hover:shadow-md'}`}>
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-gray-500 text-sm font-medium">รอการตรวจสอบ</p>
                                        <h3 className="text-3xl font-bold text-indigo-600 mt-1">{pendingCount}</h3>
                                    </div>
                                    <div className="p-2 bg-indigo-50 rounded-lg text-indigo-600"><ClockIcon className="w-6 h-6" /></div>
                                </div>
                            </div>
                            <div onClick={() => setFilter('approved')} className={`bg-white p-6 rounded-xl shadow-sm border cursor-pointer transition-all ${filter === 'approved' ? 'ring-2 ring-green-500 border-green-500' : 'hover:shadow-md'}`}>
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-gray-500 text-sm font-medium">อนุมัติแล้ว</p>
                                        <h3 className="text-3xl font-bold text-green-600 mt-1">{bookings.filter(b => b.status === 'approved').length}</h3>
                                    </div>
                                    <div className="p-2 bg-green-50 rounded-lg text-green-600"><CheckIcon className="w-6 h-6" /></div>
                                </div>
                            </div>
                            <div onClick={() => setFilter('all')} className={`bg-white p-6 rounded-xl shadow-sm border cursor-pointer transition-all ${filter === 'all' ? 'ring-2 ring-gray-400 border-gray-400' : 'hover:shadow-md'}`}>
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-gray-500 text-sm font-medium">รายการทั้งหมด</p>
                                        <h3 className="text-3xl font-bold text-gray-800 mt-1">{bookings.length}</h3>
                                    </div>
                                    <div className="p-2 bg-gray-100 rounded-lg text-gray-600"><UserIcon className="w-6 h-6" /></div>
                                </div>
                            </div>
                        </div>

                        {/* List Section */}
                        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                            <div className="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                                <h2 className="font-bold text-gray-800">
                                    {filter === 'pending' && 'รายการที่รออนุมัติ'}
                                    {filter === 'approved' && 'รายการที่อนุมัติแล้ว'}
                                    {filter === 'rejected' && 'รายการที่ไม่อนุมัติ'}
                                    {filter === 'all' && 'ประวัติการจองทั้งหมด'}
                                </h2>
                                <span className="text-xs text-gray-500">ทั้งหมด {filteredBookings.length} รายการ</span>
                            </div>

                            {filteredBookings.length === 0 ? (
                                <div className="p-12 text-center text-gray-400">
                                    <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <CheckIcon className="w-8 h-8 text-gray-300" />
                                    </div>
                                    <p>ไม่พบรายการในช่วงนี้</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-gray-500 bg-gray-50 font-medium border-b">
                                            <tr>
                                                <th className="px-6 py-3">วันที่ / เวลา</th>
                                                <th className="px-6 py-3">ห้อง / กิจกรรม</th>
                                                <th className="px-6 py-3">ผู้ขอใช้</th>
                                                <th className="px-6 py-3">สถานะ</th>
                                                <th className="px-6 py-3 text-right">การจัดการ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {filteredBookings.map((booking) => (
                                                <tr key={booking.id} className="hover:bg-slate-50 transition-colors">
                                                    <td className="px-6 py-4">
                                                        <div className="font-semibold text-gray-800">{formatDate(booking.date)}</div>
                                                        <div className="text-xs text-gray-500">{booking.timeStart} - {booking.timeEnd} น.</div>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <div className="text-indigo-600 font-medium">{ROOM_NAMES[booking.room] || booking.room}</div>
                                                        <div className="text-xs text-gray-500">{booking.subject}</div>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <div className="font-medium">{booking.name}</div>
                                                        <div className="text-xs text-gray-400">ผู้สอน: {booking.teacher || '-'}</div>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        {getStatusBadge(booking.status)}
                                                    </td>
                                                    <td className="px-6 py-4 text-right">
                                                        {booking.status === 'pending' && (
                                                            <div className="flex justify-end gap-2">
                                                                <button onClick={() => handleStatusChange(booking.id, 'rejected')} className="p-2 rounded-lg text-red-600 hover:bg-red-50 border border-transparent hover:border-red-200 transition-all" title="ไม่อนุมัติ">
                                                                    <XIcon className="w-5 h-5" />
                                                                </button>
                                                                <button onClick={() => handleStatusChange(booking.id, 'approved')} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-xs font-semibold shadow-md flex items-center gap-1 transition-all">
                                                                    <CheckIcon className="w-4 h-4" /> อนุมัติ
                                                                </button>
                                                            </div>
                                                        )}
                                                        {booking.status !== 'pending' && (
                                                            <button onClick={() => handleStatusChange(booking.id, 'pending')} className="text-xs text-gray-400 hover:text-indigo-500 underline">
                                                                แก้ไขสถานะ
                                                            </button>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);

            if (!isLoggedIn) {
                return <Login onLogin={() => setIsLoggedIn(true)} />;
            }

            return <Dashboard onLogout={() => setIsLoggedIn(false)} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>